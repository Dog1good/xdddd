-- Optimized Tracer Script with Toggling, Mouse Follow, Color Picker, and Object Pooling

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local mouse = player:GetMouse()

-- Settings for Tracers
local Settings = {
    Tracer_Color = Color3.fromRGB(0, 0, 255),
    Tracer_Thickness = 1,
    Tracer_Origin = "Bottom",
    Tracer_FollowMouse = false
}

-- Global toggle variables
_G.TracersEnabled = false
_G.TracersFollowMouse = false

-- Tracer pool to reuse tracers
local tracerPool = {}

-- Function to get or create a new tracer line
local function GetTracer()
    local tracer = table.remove(tracerPool) -- Reuse if available
    if not tracer then
        tracer = Drawing.new("Line")
        tracer.Visible = false
        tracer.Color = Settings.Tracer_Color
        tracer.Thickness = Settings.Tracer_Thickness
        tracer.Transparency = 1
    end
    return tracer
end

-- Function to return tracers to the pool
local function ReturnTracer(tracer)
    tracer.Visible = false
    table.insert(tracerPool, tracer)
end

-- Function to determine tracer origin point
local function GetTracerOrigin()
    local viewportSize = camera.ViewportSize
    if _G.TracersFollowMouse then
        return Vector2.new(mouse.X, mouse.Y + 60)
    end
    if Settings.Tracer_Origin == "Middle" then
        return viewportSize * 0.5
    elseif Settings.Tracer_Origin == "Bottom" then
        return Vector2.new(viewportSize.X * 0.5, viewportSize.Y)
    elseif Settings.Tracer_Origin == "Top" then
        return Vector2.new(viewportSize.X * 0.5, 0)
    elseif Settings.Tracer_Origin == "Left" then
        return Vector2.new(0, viewportSize.Y * 0.5)
    elseif Settings.Tracer_Origin == "Right" then
        return Vector2.new(viewportSize.X, viewportSize.Y * 0.5)
    end
    return viewportSize * 0.5
end

-- Table to store active tracers
local activeTracers = {}

-- Function to update tracers
local function UpdateTracers()
    if not _G.TracersEnabled then
        for plr, tracer in pairs(activeTracers) do
            ReturnTracer(tracer)
            activeTracers[plr] = nil
        end
        return
    end

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player then
            if not activeTracers[plr] then
                activeTracers[plr] = GetTracer()
            end

            local tracer = activeTracers[plr]
            local char = plr.Character
            if char then
                local rootPart = char:FindFirstChild("HumanoidRootPart")
                local humanoid = char:FindFirstChild("Humanoid")

                if rootPart and humanoid and humanoid.Health > 0 then
                    local screenPos, onScreen = camera:WorldToViewportPoint(rootPart.Position)
                    if onScreen then
                        tracer.From = GetTracerOrigin()
                        tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                        tracer.Visible = true
                        tracer.Color = Settings.Tracer_Color
                    else
                        tracer.Visible = false
                    end
                else
                    ReturnTracer(tracer)
                    activeTracers[plr] = nil
                end
            end
        end
    end
end

-- Function to handle new players
local function OnPlayerAdded(plr)
    if _G.TracersEnabled then
        activeTracers[plr] = GetTracer()
    end
end

-- Function to handle player removal
local function OnPlayerRemoving(plr)
    local tracer = activeTracers[plr]
    if tracer then
        ReturnTracer(tracer)
        activeTracers[plr] = nil
    end
end

-- Event connections
Players.PlayerAdded:Connect(OnPlayerAdded)
Players.PlayerRemoving:Connect(OnPlayerRemoving)

-- RunService loop for updating tracers
local tracerConnection = nil
local function ToggleTracers(enabled)
    _G.TracersEnabled = enabled

    if enabled then
        tracerConnection = RunService.RenderStepped:Connect(UpdateTracers)
    else
        if tracerConnection then
            tracerConnection:Disconnect()
            tracerConnection = nil
        end
        -- Cleanup all tracers
        for plr, tracer in pairs(activeTracers) do
            ReturnTracer(tracer)
            activeTracers[plr] = nil
        end
    end
end

-- =======================
-- GUI ELEMENTS
-- =======================

-- Toggle to enable tracers
LeftGroupBox:AddToggle('TracersToggle', {
    Text = 'Enable Tracers',
    Default = false,
    Tooltip = 'Toggle to enable or disable tracers',
    Callback = ToggleTracers
})

-- Toggle for mouse follow
LeftGroupBox:AddToggle('MouseFollowToggle', {
    Text = 'Enable Mouse Follow for Tracers',
    Default = false,
    Tooltip = 'Toggle to enable or disable tracers following the mouse',
    Callback = function(Value)
        _G.TracersFollowMouse = Value
    end
})

-- Dropdown for tracer origin
LeftGroupBox:AddDropdown('TracerPositionDropdown', {
    Values = { 'Bottom', 'Top', 'Left', 'Right' },
    Default = 1,
    Multi = false,
    Text = 'Tracer Position',
    Tooltip = 'Select the starting position of the tracers',
    Callback = function(Value)
        Settings.Tracer_Origin = Value
    end
})

Options.TracerPositionDropdown:OnChanged(function()
    print('Tracer position changed. New value:', Options.TracerPositionDropdown.Value)
end)

-- Color picker for tracer color
LeftGroupBox:AddLabel('Tracer Color'):AddColorPicker('TracerColorPicker', {
    Default = Settings.Tracer_Color,
    Title = 'Tracer Color',
    Transparency = 0, -- disables transparency
    Callback = function(Value)
        Settings.Tracer_Color = Value
        -- Update all active tracers immediately
        for _, tracer in pairs(activeTracers) do
            tracer.Color = Settings.Tracer_Color
        end
    end
})
