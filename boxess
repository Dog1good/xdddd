--// Services
Players = game:GetService("Players")
RunService = game:GetService("RunService")
LocalPlayer = Players.LocalPlayer
Camera = workspace.CurrentCamera

--// Settings
defaultcolor = Color3.fromRGB(255, 0, 0)
teamcheck = false
teamcolor = true

--// Variables
espEnabled = false
espCache = {}

--// Helper functions
newVector2, newColor3, newDrawing = Vector2.new, Color3.new, Drawing.new
tan, rad = math.tan, math.rad
round = function(...)
    local a = {}
    for i,v in next, table.pack(...) do a[i] = math.round(v) end
    return unpack(a)
end
wtvp = function(...)
    local a,b = Camera:WorldToViewportPoint(...)
    return newVector2(a.X,a.Y), b, a.Z
end

--// Create ESP
function createEsp(player)
    if player == LocalPlayer or espCache[player] then return end
    local drawings = {}
    drawings.box = newDrawing("Square")
    drawings.box.Thickness = 1
    drawings.box.Filled = false
    drawings.box.Color = defaultcolor
    drawings.box.Visible = false
    drawings.box.ZIndex = 2

    drawings.boxoutline = newDrawing("Square")
    drawings.boxoutline.Thickness = 3
    drawings.boxoutline.Filled = false
    drawings.boxoutline.Color = newColor3()
    drawings.boxoutline.Visible = false
    drawings.boxoutline.ZIndex = 1

    espCache[player] = drawings
end

--// Remove ESP
function removeEsp(player)
    if espCache[player] then
        for _, drawing in pairs(espCache[player]) do
            drawing:Remove()
        end
        espCache[player] = nil
    end
end

--// Destroy all ESP
function destroyAllEsp()
    for player, drawings in pairs(espCache) do
        for _, drawing in pairs(drawings) do
            drawing:Remove()
        end
    end
    espCache = {}
end

--// Update ESP
function updateEsp(player, drawings)
    local character = player.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    local humanoid = character and character:FindFirstChild("Humanoid")
    
    if humanoidRootPart and humanoid and humanoid.Health > 0 then
        local position, visible, depth = wtvp(humanoidRootPart.Position)
        drawings.box.Visible = visible
        drawings.boxoutline.Visible = visible

        if visible then
            local scale = 1 / (depth * tan(rad(Camera.FieldOfView / 2)) * 2) * 1000
            local width, height = round(4 * scale, 5 * scale)
            local x, y = round(position.X, position.Y)

            drawings.box.Size = newVector2(width, height)
            drawings.box.Position = newVector2(x - width/2, y - height/2)
            drawings.box.Color = teamcolor and player.TeamColor.Color or defaultcolor

            drawings.boxoutline.Size = drawings.box.Size
            drawings.boxoutline.Position = drawings.box.Position
        end
    else
        drawings.box.Visible = false
        drawings.boxoutline.Visible = false
    end
end

--// Toggle function
function ToggleESP(Value)
    espEnabled = Value
    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                createEsp(player)
            end
        end
    else
        destroyAllEsp()
    end
end

--// GUI Elements
BoxESPBox:AddToggle('espbox', {
    Text = 'Enable Box ESP',
    Default = false,
    Tooltip = 'Toggles Box ESP visibility',
    Callback = function(Value)
        ToggleESP(Value)
    end
})

BoxESPBox:AddToggle('teamcheck', {
    Text = 'Team Check',
    Default = false,
    Tooltip = 'Hide teammates ESP',
    Callback = function(Value)
        teamcheck = Value
    end
})

BoxESPBox:AddToggle('teamcolor', {
    Text = 'Use Team Colors',
    Default = true,
    Tooltip = 'Changes ESP color to player team color',
    Callback = function(Value)
        teamcolor = Value
    end
})

BoxESPBox:AddLabel('ESP Color'):AddColorPicker('espcolor', {
    Default = defaultcolor,
    Title = 'Pick a color',
    Transparency = 0,
    Callback = function(Value)
        defaultcolor = Value
    end
})

--// Main loop
RunService:BindToRenderStep("BoxESPUpdate", Enum.RenderPriority.Camera.Value, function()
    if not espEnabled then return end
    for player, drawings in pairs(espCache) do
        if player.Parent and player ~= LocalPlayer then
            if teamcheck and player.Team == LocalPlayer.Team then 
                drawings.box.Visible = false
                drawings.boxoutline.Visible = false
                continue 
            end
            updateEsp(player, drawings)
        end
    end
end)

--// Player connections
Players.PlayerAdded:Connect(function(player)
    if espEnabled then 
        createEsp(player) 
    end
end)

Players.PlayerRemoving:Connect(function(player)
    removeEsp(player)
end)
